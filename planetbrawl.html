<html>
   <head>
      <title>Planet Brawl</title>
        <style type="text/css">
        html, body {
          width:  100%;
          height: 100%;
          margin: 0px;
        }
        </style>
   <script type="text/javascript" src="Box2dWeb-2.1.a.3.min.js"></script>
   <script type="text/javascript">
        /*jslint bitwise: true, newcap: true, plusplus: true, vars: true, white: true, browser: true, devel: true */
    "use strict";
    var world;
      
      
    var   b2Vec2 = Box2D.Common.Math.b2Vec2
        ,	b2BodyDef = Box2D.Dynamics.b2BodyDef
        ,	b2Body = Box2D.Dynamics.b2Body
        ,	b2FixtureDef = Box2D.Dynamics.b2FixtureDef
        ,	b2Fixture = Box2D.Dynamics.b2Fixture
        ,	b2World = Box2D.Dynamics.b2World
        ,	b2MassData = Box2D.Collision.Shapes.b2MassData
        ,	b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
        ,	b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
        ,	b2DebugDraw = Box2D.Dynamics.b2DebugDraw   
        ,   b2Listener = Box2D.Dynamics.b2ContactListener
        ;

    function Entity() {
        this.entitytype = null;
        this.body = null;
        return this;
    }

    function Ship(mainweapon) {  
        this.entitytype = "SHIP";
        this.mainweapon = mainweapon;
        this.mainweapon_lastfired = 0;
    }
    Ship.prototype = new Entity();

    function Planet(pos,mass) {  
        this.entitytype = "PLANET";
        this.mass = mass;
        this.pos = pos;
    }
    Planet.prototype = new Entity();

    var sun = new Planet(new b2Vec2(15, 15),1000);
    var defaultmainweapon = {cooldown:300,bulletsize:0.2,bulletvelocity:10};      
    var ships = [new Ship(defaultmainweapon),new Ship(defaultmainweapon)];
       
    var controls = {};
    var keyBindings = {
        // [SHIPNR, CONTROL]
        87:[0,"FWD"],65:[0,"LEFT"],68:[0,"RIGHT"],32:[0,"FIRE"],
        38:[1,"FWD"],37:[1,"LEFT"],39:[1,"RIGHT"],13:[1,"FIRE"]
    };
      
    var listener = new b2Listener();
  
    var deleteList = [];
    listener.BeginContact = function(contact, oldManifold) {
        var sunCollision = function(sun,body) {
            // Non-ship objects burn up in the atmosphere
            var et = body.entity && body.entity.entitytype;
            if (et !== "SHIP") { deleteList.push(body);}
        },

        shipCollision = function(ship,body) {
            
            function doCollision(ship,body) {
                // Perform the actual collision
                // Ship collisions hurt the ship, but only once in a while                                
                var timeout = 1000,
                    t = new Date().getTime();
                    
                if (body.lastContacts && body.lastContacts[ship]) {
                    if (t - body.lastContacts[ship] < timeout) {
                        return;
                    }
                }
                console.debug("OUCH!");
            
                if (body.lastContacts === undefined) {
                    body.lastContacts = {};
                }
                body.lastContacts[ship] = t;                                
            }
            // hurt!
            doCollision(ship,body);
            
            // If ship-to-ship, perform reverse collision too.
            var et = body.entity && body.entity.entitytype;
            if (et === "SHIP") {
                doCollision(body.entity, ship.body);
            }
        };
        
        
        var bodyA = contact.GetFixtureA().GetBody(),
            bodyB = contact.GetFixtureB().GetBody(),
            etA = bodyA.entity && bodyA.entity.entitytype,
            etB = bodyB.entity && bodyB.entity.entitytype;           

        if (etA === "SHIP") { shipCollision(bodyA.entity,bodyB);return; }
        if (etB === "SHIP") { shipCollision(bodyB.entity,bodyA);return; } 

        if (bodyA === sun.body) { sunCollision(sun,bodyB);return; }
        if (bodyB === sun.body) { sunCollision(sun,bodyA);return; }
            
    };
      
      function update() {
        var ctx = document.getElementById("canvas").getContext("2d");
        ctx.canvas.width  = window.innerWidth;
        ctx.canvas.height = window.innerHeight;
        // Clean up delete List
        deleteList.map( function(body)
        {
            world.DestroyBody(body);
        });


        // Check if any of the controls are activated
        var keyCode;
        for (keyCode in controls) {
            var control = keyBindings[keyCode];
            if (control) {
                //console.log(control);
                var shipnr = control[0];
                var ship = ships[shipnr];
                if (control[1] === "FWD") {
                    // Forward!
                    ship.body.ApplyForce(ship.body.GetWorldVector(new b2Vec2(0,-10)),ship.body.GetWorldCenter());
                }
                if (control[1] === "LEFT") {
                    ship.body.ApplyTorque(-10);
                }
                if (control[1] === "RIGHT") {
                    ship.body.ApplyTorque(10);
                }
                if (control[1] === "FIRE") {
                    var t = new Date().getTime();
                    if ((t - ship.mainweapon_lastfired) > ship.mainweapon.cooldown) {
                        console.debug("FIRE!!");
                        ship.mainweapon_lastfired = t;
                        // Create a bullet
                        var fixDef = new b2FixtureDef();
                        fixDef.density = 1.0;
                        fixDef.friction = 0.5;
                        fixDef.restitution = 0.2;

                        var bodyDef = new b2BodyDef();       
                        bodyDef.type = b2Body.b2_dynamicBody;
                        fixDef.shape = new b2CircleShape(ship.mainweapon.bulletsize);            
                        bodyDef.position.SetV(ship.body.GetWorldPoint(new b2Vec2(0,-2)));                        
                        var body = world.CreateBody(bodyDef);
                        body.CreateFixture(fixDef);         
                        body.SetLinearVelocity(ship.body.GetWorldVector(new b2Vec2(0,-20)));
                        body.lastContacts = {};
                    }
                }
            }
        }
        
        // Dampen the angular velocity
        ships[0].body.SetAngularVelocity(ships[0].body.GetAngularVelocity()*0.95);
        ships[1].body.SetAngularVelocity(ships[1].body.GetAngularVelocity()*0.95);

        // Do gravity
        var b;
        for (b = world.GetBodyList(); b; b = b.GetNext())
        {            
            //b.SetAwake(true);
            var md = new b2MassData();
            b.GetMassData( md );
            var r = new b2Vec2();
            r.SetV(sun.pos);
            r.Subtract(b.GetWorldCenter());
            var rabs = r.Length(); 
            if (rabs>1.0) {      
                var f = r.Copy();
                f.Normalize();
                f.Multiply(10.0*md.mass/rabs);
                b.ApplyForce(f,b.GetWorldCenter());
            }
        }
         world.Step(
               1 / 60   //frame-rate
            ,  10       //velocity iterations
            ,  10       //position iterations
         );
         world.DrawDebugData();
         world.ClearForces();
      }
      
      function init() {
        
        document.addEventListener('keydown', function(event) {
            controls[event.keyCode] = 1;
            //console.log("DOWN: "+event.keyCode);
        });
        
        document.addEventListener('keyup', function(event) {
            delete controls[event.keyCode];
            //onsole.log("UP: "+event.keyCode);
        });

         
         world = new b2World(
               new b2Vec2(0, 0)    //gravity
            ,  true                 //allow sleep
         );
         
         world.SetContactListener(listener);
         
         var fixDef = new b2FixtureDef();
         fixDef.density = 1.0;
         fixDef.friction = 0.5;
         fixDef.restitution = 0.2;
         
         var bodyDef = new b2BodyDef();                  
         
         // Create the planet
         bodyDef.type = b2Body.b2_staticBody;
         fixDef.shape = new b2CircleShape(
                  1.0
               );            
         bodyDef.position.x = sun.pos.x;
         bodyDef.position.y = sun.pos.y;
         sun.body = world.CreateBody(bodyDef);
         sun.body.CreateFixture(fixDef);
         sun.body.lastContacts = {};
         
         
         // create the ships
         bodyDef.type = b2Body.b2_dynamicBody;
         fixDef.shape = new b2PolygonShape();
         fixDef.shape.SetAsBox(
                     0.5 //half width
                  ,  1 //half height
               );
         bodyDef.position.x = 2;
         bodyDef.position.y = 2;
         var i;
         for (i=0;i<2;i++) {
            bodyDef.position.x += 3*i;
            ships[i].body = world.CreateBody(bodyDef);
            ships[i].body.CreateFixture(fixDef);
            ships[i].body.entity = ships[i]; 
        }
         
         //create some objects
         bodyDef.type = b2Body.b2_dynamicBody;
         for(i = 0; i < 10; ++i) {
            if(Math.random() > 0.5) {
               fixDef.shape = new b2PolygonShape();
               fixDef.shape.SetAsBox(
                     Math.random()/5 + 0.1 //half width
                  ,  Math.random()/5 + 0.1 //half height
               );
            } else {
               fixDef.shape = new b2CircleShape(
                  Math.random()/5 + 0.1 //radius
               );
            }
            bodyDef.position.x = Math.random() * 10;
            bodyDef.position.y = Math.random() * 10;            
            var body = world.CreateBody(bodyDef);
            body.CreateFixture(fixDef);
            body.SetLinearVelocity(new b2Vec2(Math.random()*4,Math.random()*4-2));
            body.lastContacts={}; // used for collision damage
         }
         
         //setup debug draw
         var debugDraw = new b2DebugDraw();
			debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
			debugDraw.SetDrawScale(30.0);
			debugDraw.SetFillAlpha(0.3);
			debugDraw.SetLineThickness(1.0);
			debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
			world.SetDebugDraw(debugDraw);
         
         window.setInterval(update, 1000 / 60);
      }
      
      
   
   </script>
      </head>
<body onload="init();">
      <canvas id="canvas"></canvas>
   </body>
   
   
</html>